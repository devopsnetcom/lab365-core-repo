name: Auto Destroy Labs (Nightly)

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Destroy All Lab Resource Groups (except protected)
        run: |
          PROTECTED_RGS=("shared-infra-rg" "tfstate-rg")
          echo "üîç Cleaning up labs..."
          for rg in $(az group list --query "[?contains(name,'-rg')].name" -o tsv); do
            SKIP=false
            for protected in "${PROTECTED_RGS[@]}"; do
              if [[ "$rg" == "$protected" ]]; then
                echo "üõë Skipping protected resource group: $rg"
                SKIP=true
                break
              fi
            done
            if [ "$SKIP" = false ]; then
              echo "üí£ Deleting resource group: $rg"
              az group delete --name "$rg" --yes --no-wait
            fi
          done
